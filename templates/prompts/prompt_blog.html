<!-- Load marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
      function renderBlogDetails(details) {
            const container = document.createElement("div");
            container.className = "blog-container";

            // Main content
            const main = document.createElement("div");
            main.className = "blog-main";
            main.innerHTML = `
                <div class="blog-content message">
                    ${marked.parse(details.blog_content)}
                </div>
            `;

            // Create TOC
            const toc = document.createElement("div");
            toc.className = "blog-toc";
            toc.innerHTML = `<ul></ul>`;

            const blogContentDiv = document.createElement("div");
            blogContentDiv.innerHTML = marked.parse(details.blog_content);

            // Get headings
            const headings = blogContentDiv.querySelectorAll("h1, h2");
            const tocList = toc.querySelector("ul");

            headings.forEach((h, i) => {
                  const id = `heading-${i}`;
                  h.id = id;

                  const li = document.createElement("li");
                  const a = document.createElement("a");
                  a.href = `#${id}`;
                  a.textContent = h.textContent;

                  // Smooth scroll to center of screen
                  a.addEventListener("click", function (e) {
                        e.preventDefault();
                        const target = document.getElementById(id);
                        const targetRect = target.getBoundingClientRect();
                        const targetTop = targetRect.top + window.pageYOffset;
                        const windowHeight = window.innerHeight;
                        const offsetTop = targetTop - windowHeight / 2 + targetRect.height / 2;

                        window.scrollTo({
                              top: offsetTop,
                              behavior: "smooth",
                        });
                  });

                  li.appendChild(a);
                  tocList.appendChild(li);
            });

            // Insert headings into real blog content
            main.querySelector(".blog-content").innerHTML = blogContentDiv.innerHTML;

            // Append main & toc
            container.appendChild(main);
            container.appendChild(toc);
            document.getElementById("content").appendChild(container);

            // Scroll spy (highlight active heading) - FIXED VERSION
            const tocLinks = toc.querySelectorAll("a");
            if (tocLinks.length > 0) tocLinks[0].classList.add("active");

            // Function to find the currently active heading
            function updateActiveHeading() {
                  const headingsInContent = main.querySelectorAll("h1, h2");
                  let activeHeading = null;
                  const scrollTop = window.pageYOffset;
                  const windowHeight = window.innerHeight;
                  const centerOfScreen = scrollTop + windowHeight / 2;

                  // Find the heading closest to the center of the screen
                  let minDistance = Infinity;
                  headingsInContent.forEach((heading) => {
                        const rect = heading.getBoundingClientRect();
                        const headingTop = rect.top + scrollTop;
                        const distance = Math.abs(headingTop - centerOfScreen);

                        if (distance < minDistance) {
                              minDistance = distance;
                              activeHeading = heading;
                        }
                  });

                  // Update active state
                  if (activeHeading) {
                        tocLinks.forEach((link) => link.classList.remove("active"));
                        const activeLink = toc.querySelector(`a[href="#${activeHeading.id}"]`);
                        if (activeLink) activeLink.classList.add("active");
                  }
            }

            // Use scroll event instead of IntersectionObserver for more responsive updates
            let scrollTimeout;
            window.addEventListener("scroll", function () {
                  clearTimeout(scrollTimeout);
                  scrollTimeout = setTimeout(updateActiveHeading, 10);
            });

            // Initial update
            updateActiveHeading();
      }
</script>
{% include 'highlightJs/highlight_js.html' %}
