<!-- Load marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const fileContent = {{ file_content|tojson }};

    function handleFileContent(content) {
        console.log("File Content:", content);
    }

    if (fileContent) {
        renderBlogDetails(fileContent);
    }
    
    function renderBlogDetails(fileContent) {
        const container = document.createElement("div");
        container.className = "blog-container";

        // Main content
        const main = document.createElement("div");
        main.className = "blog-main prompt-main-content";
        
        // Parse markdown first
        const parsedContent = marked.parse(fileContent);
        main.innerHTML = `
            <div class="blog-content message">
                ${parsedContent}
            </div>
        `;

        // Create TOC
        const toc = document.createElement("div");
        toc.className = "blog-toc";
        toc.innerHTML = `<ul></ul>`;

        // Append main & toc first so elements are in DOM
        container.appendChild(main);
        container.appendChild(toc);
        document.getElementById("content").appendChild(container);

        // Now work with elements that are in the DOM
        const blogContent = main.querySelector(".blog-content");
        const headings = blogContent.querySelectorAll("h1, h2");
        const tocList = toc.querySelector("ul");

        // Add IDs to headings and create TOC links
        headings.forEach((heading, i) => {
            const id = `heading-${i}`;
            heading.id = id;

            const li = document.createElement("li");
            const a = document.createElement("a");
            a.href = `#${id}`;
            a.textContent = heading.textContent;

            // Simple direct scroll approach
            a.addEventListener("click", function (e) {
                e.preventDefault();
                
                // Remove hash from URL to prevent browser default behavior
                history.replaceState(null, null, ' ');
                
                // Direct element focus and scroll
                const targetHeading = document.getElementById(id);
                if (targetHeading) {
                    // Try multiple scroll approaches simultaneously
                    
                    // Approach 1: Direct element scroll into view
                    targetHeading.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                    
                    // Approach 2: Scroll window directly to element position
                    setTimeout(() => {
                        const rect = targetHeading.getBoundingClientRect();
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        const targetPosition = rect.top + scrollTop - 100; // 100px offset from top
                        
                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }, 50);
                    
                    // Approach 3: Try scrolling any parent containers
                    let parent = targetHeading.parentElement;
                    while (parent && parent !== document.body) {
                        if (parent.scrollHeight > parent.clientHeight) {
                            const parentRect = parent.getBoundingClientRect();
                            const targetRect = targetHeading.getBoundingClientRect();
                            const relativePosition = targetRect.top - parentRect.top + parent.scrollTop;
                            
                            parent.scrollTo({
                                top: relativePosition - 50,
                                behavior: 'smooth'
                            });
                            break;
                        }
                        parent = parent.parentElement;
                    }
                }
            });

            li.appendChild(a);
            tocList.appendChild(li);
        });

        // Scroll spy functionality
        const tocLinks = toc.querySelectorAll("a");
        if (tocLinks.length > 0) tocLinks[0].classList.add("active");

        // Function to update active heading based on scroll position
        function updateActiveHeading() {
            let activeHeading = null;
            const scrollPos = window.scrollY + 200; // Offset for better detection

            headings.forEach((heading) => {
                const rect = heading.getBoundingClientRect();
                const absoluteTop = rect.top + window.scrollY;
                
                if (absoluteTop <= scrollPos) {
                    activeHeading = heading;
                }
            });

            // Update active state in TOC
            tocLinks.forEach(link => link.classList.remove("active"));
            if (activeHeading) {
                const activeLink = toc.querySelector(`a[href="#${activeHeading.id}"]`);
                if (activeLink) {
                    activeLink.classList.add("active");
                }
            }
        }

        // Listen for scroll events
        let scrollTimeout;
        window.addEventListener("scroll", function () {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateActiveHeading, 50);
        });

        // Also try listening to the prompt-main-content container
        const promptMain = document.querySelector('.prompt-main-content');
        if (promptMain) {
            promptMain.addEventListener("scroll", function () {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(updateActiveHeading, 50);
            });
        }

        // Initial update
        updateActiveHeading();
        
        // Debug info
        console.log('TOC Setup Complete');
        console.log('Found headings:', headings.length);
        console.log('Prompt main element:', promptMain);
        console.log('Window scroll available:', window.scrollY !== undefined);
    }
</script>
{% include 'highlightJs/highlight_js.html' %}