<!-- Hamburger button (Mobile Only) -->
<button class="m-menu-open-btn" onclick="openMobileMenu()">
    <img class="w-6 h-6" src="/static/images/lucidev-icons/panel-right-close.svg" alt="Menu icon" />
</button>

<!-- Mobile Sidebar -->
<div id="mobileSidebar" class="m-sidebar">
    <div class="m-menu-close" onclick="closeMobileMenu()">
        <img src="/static/images/lucidev-icons/x.svg" alt="" />
    </div>
    <div id="mobileMenu"></div>
</div>

<!-- Desktop Sidebar -->
<div id="desktopSidebar" class="d-sidebar">
    <div id="desktopMenu"></div>
</div>

<script>
const sidebarData = {{ sidebar | tojson }};
const PagePrefix = {{ page_prefix | tojson }};
const activePath = "{{ initial_path }}";

console.log(PagePrefix)

// Get the chain of paths from root to active file/folder
function getActiveStack(data, targetPath) {
    const stack = [];

    function dfs(items, pathSoFar) {
        for (let item of items) {
            const currentPath = item.path;
            if (targetPath === currentPath) {
                stack.push(currentPath);
                return true;
            }
            if (item.type === "folder" && dfs(item.children, currentPath)) {
                stack.push(currentPath);
                return true;
            }
        }
        return false;
    }

    dfs(data, "");
    return stack.reverse(); // so level1 → level2 → ...
}

/* ---------------- MOBILE RENDER ---------------- */
function renderMobileMenu(containerId, data) {
    const container = document.getElementById(containerId);
    let stack = [data];
    let currentPath = "";

    function draw(items) {
        container.innerHTML = '';

        if (stack.length > 1) {
            const back = document.createElement('div');
            back.className = 'm-menu-back';
            back.innerHTML = `<img src="/static/images/lucidev-icons/chevron-left.svg" alt="" />`;
            back.onclick = () => {
                stack.pop();
                currentPath = currentPath.split('/').slice(0, -1).join('/');
                history.pushState({}, "", `/${PagePrefix}/${currentPath}`);
                draw(stack[stack.length - 1]);
            };
            container.appendChild(back);
        }

        const sorted = [...items].sort((a,b) => (a.type==='folder') ? -1 : 1);
        sorted.forEach(item => {
            const div = document.createElement('div');
            div.className = 'm-menu-item';
            div.innerHTML = `
                <span>${item.name.replace('.md', '')}</span>
                ${item.type === 'folder' ? '<img src="/static/images/lucidev-icons/chevron-right.svg" alt="" />' : ''}
            `;
            div.onclick = () => {
                if (item.type === 'folder') {
                    stack.push(item.children);
                    currentPath = item.path;
                    history.pushState({}, "", `/${PagePrefix}/${item.path}`);
                    draw(item.children);
                } else {
                    window.location.href = `/${PagePrefix}/${item.path}`;
                }
            };
            container.appendChild(div);
        });
    }

    draw(data);
}

/* ---------------- DESKTOP RENDER ---------------- */
function renderDesktopMenu(containerId, data, activePath) {
    const container = document.getElementById(containerId);
    const activeStack = activePath ? getActiveStack(data, activePath) : [];

    function buildList(items, activeStack) {
    const ul = document.createElement('ul');
    ul.className = 'd-menu-list';

    const sorted = [...items].sort((a, b) => (a.type === 'folder' ? -1 : 1));
    sorted.forEach(item => {
        const isActive = item.path === activePath;
        const isOpen = activeStack.includes(item.path);

        const li = document.createElement('li');
        li.className = `${item.type} ${isOpen ? 'open' : ''} ${isActive ? 'active' : ''}`;

        // build inner content differently for folder vs file
        let innerHTML = '';
        if (item.type === 'folder') {
            li.classList.add('d-folder'); // ✅ special folder class
            innerHTML = `
                <span>${item.name.replace('.md', '')}</span>
                <span class="d-chevron">
                    <img src="/static/images/lucidev-icons/chevron-right.svg" alt="" />
                </span>
            `;
        } else {
            li.classList.add('d-doc'); // ✅ special doc class
            innerHTML = `<span>${item.name.replace('.md', '')}</span>`;
        }

        const div = document.createElement('div');
        div.className = 'd-menu-item';
        div.innerHTML = innerHTML;

        if (item.type === 'folder') {
            div.onclick = () => {
                li.classList.toggle('open');
                let childUl = li.querySelector(':scope > ul');
                if (!childUl) {
                    li.appendChild(buildList(item.children, activeStack));
                } else {
                    childUl.style.display = childUl.style.display === 'none' ? 'block' : 'none';
                }
            };

            li.appendChild(div);
            if (isOpen) {
                li.appendChild(buildList(item.children, activeStack));
            }
        } else {
            div.onclick = () => {
                window.location.href = `/${PagePrefix}/${item.path}`;
            };
            li.appendChild(div);
        }

        ul.appendChild(li);
    });

    return ul;
}


    container.innerHTML = '';
    container.appendChild(buildList(data, activeStack));
}


/* ---------------- MENU CONTROL ---------------- */
function closeMobileMenu() {
    document.getElementById('mobileSidebar').style.display = 'none';
}

function openMobileMenu() {
    document.getElementById('mobileSidebar').style.display = 'block';
}

renderMobileMenu('mobileMenu', sidebarData);
renderDesktopMenu('desktopMenu', sidebarData, activePath);
</script>
