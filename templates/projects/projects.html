<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portfolio Dashboard</title>
</head>
<body>
  <!-- Fixed Header -->
  {% include 'header/new_header.html' %}

  <div class="PROJECTcontainer">
    <!-- PROJECTSidebar (desktop) -->
    <aside class="PROJECTSidebar">
      <div class="PROJECTSidebar-content">
        <h2>Filters</h2>
        
        <div class="filter-section">
          <h3>Platform</h3>
          <div id="platform-list" class="filter-options">
            <!-- Platform filters will be dynamically populated -->
          </div>
        </div>

        <div class="filter-section">
          <h3>Tech Stack</h3>
          <div id="tech-stack-list" class="filter-options">
            <!-- Tech stack filters will be dynamically populated -->
          </div>
        </div>

        <div class="filter-section">
          <h3>Domain</h3>
          <div id="domain-list" class="filter-options">
            <!-- Domain filters will be dynamically populated -->
          </div>
        </div>
      </div>
      
      <div class="PROJECTSidebar-footer">
        <button id="clear-filters" class="clear-btn">Clear All</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="PROJECTmain-content">
      <div id="loading" style="text-align: center; padding: 20px;">Loading projects...</div>
      <div id="PROJECTCards-container" class="PROJECTCards-grid"></div>
    </main>
  </div>

  <!-- Mobile Filter Button -->
  <button id="filter-toggle" class="filter-toggle">
    <img src="/static/images/lucidev-icons/funnel.svg" alt="Close menu" class="w-6 h-6" />
  </button>

  <!-- Mobile Overlay -->
  <div id="PROJECTmobile-overlay" class="PROJECTmobile-overlay">
    <div class="PROJECTmobile-overlay-header">
      <h2>Filters</h2>
      <button id="close-overlay" class="close-btn">
            <img src="/static/images/lucidev-icons/x.svg" alt="Close menu" class="w-6 h-6" />
      </button>
    </div>
    <div class="PROJECTmobile-overlay-content">
      <div class="filter-section">
        <h3>Platform</h3>
        <div id="platform-list-mobile" class="filter-options">
          <!-- Platform filters will be dynamically populated -->
        </div>
      </div>

      <div class="filter-section">
        <h3>Tech Stack</h3>
        <div id="tech-stack-list-mobile" class="filter-options">
          <!-- Tech stack filters will be dynamically populated -->
        </div>
      </div>

      <div class="filter-section">
        <h3>Domain</h3>
        <div id="domain-list-mobile" class="filter-options">
          <!-- Domain filters will be dynamically populated -->
        </div>
      </div>

      <div style="margin-top: 24px;">
        <button id="clear-filters-mobile" class="clear-btn">Clear All</button>
      </div>
    </div>
  </div>

  <script>
    const defaultImage = "https://img.freepik.com/premium-vector/soft-pastel-gradient-background-with-gentle-transitions_1304147-271914.jpg?w=740&q=80";
    let projects = [];
    let allTechStacks = [];
    let allDomains = [];
    let allPlatforms = [];

    // Fetch projects from Flask route
    async function fetchProjects() {
      try {
        const response = await fetch('/projects_json');
        const data = await response.json();
        projects = data;
        
        // Extract unique values for filters
        extractFilterOptions();
        
        // Populate filter UI
        populateFilters();
        
        // Render all projects initially
        renderPROJECTCards(projects);
        
        // Hide loading indicator
        document.getElementById('loading').style.display = 'none';
      } catch (error) {
        console.error('Error fetching projects:', error);
        document.getElementById('loading').innerHTML = 'Error loading projects. Please try again.';
      }
    }

    // Extract unique filter options from projects
    function extractFilterOptions() {
      const techStackSet = new Set();
      const domainSet = new Set();
      const platformSet = new Set();

      projects.forEach(project => {
        // Tech stacks
        if (project.tech_stack) {
          if (Array.isArray(project.tech_stack)) {
            project.tech_stack.forEach(tech => techStackSet.add(tech));
          } else {
            techStackSet.add(project.tech_stack);
          }
        }

        // Domains
        if (project.domain) {
          if (Array.isArray(project.domain)) {
            project.domain.forEach(domain => domainSet.add(domain));
          } else {
            domainSet.add(project.domain);
          }
        }

        // Platforms
        if (project.platform) {
          if (Array.isArray(project.platform)) {
            project.platform.forEach(platform => platformSet.add(platform));
          } else {
            platformSet.add(project.platform);
          }
        }
      });

      allTechStacks = Array.from(techStackSet).sort();
      allDomains = Array.from(domainSet).sort();
      allPlatforms = Array.from(platformSet).sort();
    }

    // Populate filter UI for both desktop and mobile
    function populateFilters() {
      // Populate platforms
      populateFilterSection('platform', allPlatforms);
      
      // Populate tech stacks
      populateFilterSection('tech-stack', allTechStacks);
      
      // Populate domains
      populateFilterSection('domain', allDomains);
    }

    function populateFilterSection(filterType, options) {
      const desktopContainer = document.getElementById(`${filterType}-list`);
      const mobileContainer = document.getElementById(`${filterType}-list-mobile`);
      
      // Clear existing content
      desktopContainer.innerHTML = '';
      mobileContainer.innerHTML = '';
      
      options.forEach((option, index) => {
        const sanitizedId = `${filterType}-${index}`;
        
        // Desktop
        const desktopOption = document.createElement('div');
        desktopOption.className = 'filter-option';
        desktopOption.innerHTML = `
          <input type="checkbox" value="${option}" name="${filterType}" id="${sanitizedId}">
          <label for="${sanitizedId}">${option}</label>
        `;
        desktopContainer.appendChild(desktopOption);

        // Mobile
        const mobileOption = document.createElement('div');
        mobileOption.className = 'filter-option';
        mobileOption.innerHTML = `
          <input type="checkbox" value="${option}" name="${filterType}-mobile" id="${sanitizedId}-mobile">
          <label for="${sanitizedId}-mobile">${option}</label>
        `;
        mobileContainer.appendChild(mobileOption);
      });
    }

    // Render project PROJECTCards
    function renderPROJECTCards(data) {
      const container = document.getElementById('PROJECTCards-container');
      container.innerHTML = '';
      
      if (data.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No projects match the selected filters.</div>';
        return;
      }
      
      data.forEach(project => {
        // Handle tech stack (can be array or string)
        let techArray = [];
        if (project.tech_stack) {
          techArray = Array.isArray(project.tech_stack) ? project.tech_stack : [project.tech_stack];
        }
        
        const techTags = techArray.slice(0, 4).map(t => 
          `<span class="tech-tag">${t}</span>`
        ).join('');
        
        // Handle demo button
        const demoButton = (project.demo || project.has_demo) ? 
          `<button class="demo-btn"${project.demo_url ? ` onclick="window.open('${project.demo_url}', '_blank')"` : ''}>View Demo</button>` : '';
        
        // Handle platform and domain (can be arrays or strings)
        const platformText = Array.isArray(project.platform) ? project.platform.join(', ') : (project.platform || 'N/A');
        const domainText = Array.isArray(project.domain) ? project.domain.join(', ') : (project.domain || 'N/A');
        
        const PROJECTCard = document.createElement('div');
        PROJECTCard.className = 'PROJECTCard';
        PROJECTCard.innerHTML = `
          <img src="${project.image}" alt="${project.title}">
          <div class="PROJECTCard-content">
            <h3 class="PROJECTCard-title">${project.title}</h3>
            <p class="PROJECTCard-description">${project.description}</p>
            <p class="PROJECTCard-meta"><strong>Platform:</strong> ${platformText} | <strong>Domain:</strong> ${domainText}</p>
            <div class="tech-tags">${techTags}</div>
            ${demoButton}
          </div>
        `;
        container.appendChild(PROJECTCard);
      });
    }

    // Get selected filters from both desktop and mobile
    function getSelectedFilters() {
      const platforms = [
        ...Array.from(document.querySelectorAll('input[name="platform"]:checked')),
        ...Array.from(document.querySelectorAll('input[name="platform-mobile"]:checked'))
      ].map(el => el.value);
      
      const domains = [
        ...Array.from(document.querySelectorAll('input[name="domain"]:checked')),
        ...Array.from(document.querySelectorAll('input[name="domain-mobile"]:checked'))
      ].map(el => el.value);
      
      const techStacks = [
        ...Array.from(document.querySelectorAll('input[name="tech-stack"]:checked')),
        ...Array.from(document.querySelectorAll('input[name="tech-stack-mobile"]:checked'))
      ].map(el => el.value);
      
      return { platforms, domains, techStacks };
    }

    // Filter projects based on selected filters
    function filterProjects() {
      const { platforms, domains, techStacks } = getSelectedFilters();
      let filtered = projects;
      
      if (platforms.length) {
        filtered = filtered.filter(p => {
          const projectPlatforms = Array.isArray(p.platform) ? p.platform : [p.platform];
          return platforms.some(platform => projectPlatforms.includes(platform));
        });
      }
      
      if (domains.length) {
        filtered = filtered.filter(p => {
          const projectDomains = Array.isArray(p.domain) ? p.domain : [p.domain];
          return domains.some(domain => projectDomains.includes(domain));
        });
      }
      
      if (techStacks.length) {
        filtered = filtered.filter(p => {
          const projectTechStacks = Array.isArray(p.tech_stack) ? p.tech_stack : [p.tech_stack];
          return techStacks.some(tech => projectTechStacks.includes(tech));
        });
      }
      
      renderPROJECTCards(filtered);
    }

    // Sync filters between desktop and mobile
    function syncFilters(sourceInput) {
      const name = sourceInput.name;
      const value = sourceInput.value;
      const isChecked = sourceInput.checked;
      
      let targetName;
      if (name.includes('-mobile')) {
        targetName = name.replace('-mobile', '');
      } else {
        targetName = name + '-mobile';
      }
      
      const targetInput = document.querySelector(`input[name="${targetName}"][value="${value}"]`);
      if (targetInput) {
        targetInput.checked = isChecked;
      }
    }

    // Clear all filters
    function clearAllFilters() {
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
      });
      renderPROJECTCards(projects);
    }

    // Initialize the app
    function init() {
      // Fetch projects and initialize everything
      fetchProjects();
      
      // Add event listeners for filter changes
      document.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox') {
          syncFilters(e.target);
          filterProjects();
        }
      });
      
      // Clear filters buttons
      document.getElementById('clear-filters').addEventListener('click', clearAllFilters);
      document.getElementById('clear-filters-mobile').addEventListener('click', clearAllFilters);
      
      // Mobile overlay controls
      document.getElementById('filter-toggle').addEventListener('click', () => {
        document.getElementById('PROJECTmobile-overlay').style.display = 'flex';
        document.body.style.overflow = 'hidden';
      });
      
      document.getElementById('close-overlay').addEventListener('click', () => {
        document.getElementById('PROJECTmobile-overlay').style.display = 'none';
        document.body.style.overflow = 'auto';
      });
    }

    // Start the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>